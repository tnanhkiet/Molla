@{
    Layout = "_Layout";
    ViewData["Title"] = "Trang chủ";
}

<main class="main">
        	<div class="page-header text-center" style="background-image: url('/assets/images/page-header-bg.jpg')">
        		<div class="container">
        			<h1 class="page-title">Trang Chủ</h1>
        		</div><!-- End .container -->
        	</div><!-- End .page-header -->
            <div class="page-content pt-5">
                <div class="container">
                	<div class="row">
                		<div class="col-lg-9">
                			<div class="toolbox">
                				<div class="toolbox-left">
                					<div class="toolbox-info">
                						Có <span>0</span> sản phẩm
                					</div><!-- End .toolbox-info -->
                				</div><!-- End .toolbox-left -->

                				<div class="toolbox-right">
                					<div class="toolbox-sort">
                						<label for="sortby">Sắp xếp theo:</label>
                						<div class="select-custom">
											<select name="sortby" id="sortby" class="form-control">
												<option value="Date" selected="selected">Mới nhất</option>
												<option value="Rated">Xếp hạng</option>
											</select>
										</div>
                					</div><!-- End .toolbox-sort -->
                				</div><!-- End .toolbox-right -->
                			</div><!-- End .toolbox -->

                            <div class="products mb-3" id="products">
                            </div><!-- End .products -->

                			<nav aria-label="Page navigation">
							    <ul class="pagination">
							        @* <li class="page-item disabled">
							            <a class="page-link page-link-prev" href="#" aria-label="Previous" tabindex="-1" aria-disabled="true">
							                <span aria-hidden="true"><i class="icon-long-arrow-left"></i></span>Trước
							            </a>
							        </li>
							        <li class="page-item active" aria-current="page"><a class="page-link" href="#">1</a></li>
							        <li class="page-item"><a class="page-link" href="#">2</a></li>
							        <li class="page-item"><a class="page-link" href="#">3</a></li>
							        <li class="page-item-total">of 6</li>
							        <li class="page-item">
							            <a class="page-link page-link-next" href="#" aria-label="Next">
							                Sau <span aria-hidden="true"><i class="icon-long-arrow-right"></i></span>
							            </a>
							        </li> *@
							    </ul>
							</nav>
                		</div><!-- End .col-lg-9 -->
                		<aside class="col-lg-3 order-lg-first">
                			<div class="sidebar sidebar-shop">
                				<div class="widget widget-clean">
                					<label>Lọc theo:</label>
                				</div><!-- End .widget widget-clean -->

                				<div class="widget widget-collapsible">
    								<h3 class="widget-title">
									    <a data-toggle="collapse" href="#widget-1" role="button" aria-expanded="true" aria-controls="widget-1">
									        Chuyên mục
									    </a>
									</h3><!-- End .widget-title -->

									<div class="collapse show" id="widget-1">
										<div class="widget-body">
											<div class="filter-items filter-items-count">
                                                @{
                                                    List<List<string>> categories = (List<List<string>>)ViewBag.Categories;
                                                    foreach (var item in categories)
                                                    {
                                                        <div class="filter-item">
                                                            <div class="custom-control custom-checkbox">
                                                                <input type="checkbox" name="category" class="custom-control-input" value="@item[0]" id="@item[0]">
                                                                <label class="custom-control-label" for="@item[0]">@item[1]</label>
                                                            </div><!-- End .custom-checkbox -->
                                                            <span class="item-count">@item[2]</span>
												        </div>
                                                    }
                                                }
											</div><!-- End .filter-items -->
										</div><!-- End .widget-body -->
									</div><!-- End .collapse -->
        						</div><!-- End .widget -->

        						<div class="widget widget-collapsible">
    								<h3 class="widget-title">
									    <a data-toggle="collapse" href="#widget-2" role="button" aria-expanded="true" aria-controls="widget-2">
									        Size
									    </a>
									</h3><!-- End .widget-title -->

									<div class="collapse show" id="widget-2">
										<div class="widget-body">
											<div class="filter-items">
                                                @{
                                                    List<Size> sizes = (List<Size>)ViewBag.Sizes;
                                                    foreach (var item in sizes)
                                                    {
                                                        <div class="filter-item">
                                                            <div class="custom-control custom-checkbox">
                                                                <input type="checkbox" name="size" value="@item.Id" class="custom-control-input" id="@item.Id">
                                                                <label class="custom-control-label" for="@item.Id">@item.Name</label>
                                                            </div><!-- End .custom-checkbox -->
												        </div>
                                                    }
                                                }
											</div><!-- End .filter-items -->
										</div><!-- End .widget-body -->
									</div><!-- End .collapse -->
        						</div><!-- End .widget -->

        						<div class="widget widget-collapsible">
    								<h3 class="widget-title">
									    <a data-toggle="collapse" href="#widget-3" role="button" aria-expanded="true" aria-controls="widget-3">
									        Màu sắc
									    </a>
									</h3><!-- End .widget-title -->

									<div class="collapse show" id="widget-3">
										<div class="widget-body">
											<div class="filter-colors">
                                                @{
                                                    List<Color> colors = (List<Color>)ViewBag.Colors;
                                                    foreach (var item in colors)
                                                    {
                                                        <a href="#" data-id="@item.Id" style="background: @item.Code;"><span class="sr-only">@item.Name</span></a>
                                                    }
                                                }
											</div><!-- End .filter-colors -->
										</div><!-- End .widget-body -->
									</div><!-- End .collapse -->
        						</div><!-- End .widget -->

        						<div class="widget widget-collapsible">
    								<h3 class="widget-title">
									    <a data-toggle="collapse" href="#widget-4" role="button" aria-expanded="true" aria-controls="widget-4">
									        Thương hiệu
									    </a>
									</h3><!-- End .widget-title -->

									<div class="collapse show" id="widget-4">
										<div class="widget-body">
											<div class="filter-items">
                                                @{
                                                    List<Brand> brands = (List<Brand>)ViewBag.Brands;
                                                    foreach (var item in brands)
                                                    {
                                                        <div class="filter-item">
                                                            <div class="custom-control custom-checkbox">
                                                                <input type="checkbox" name="brand" value="@item.Id" class="custom-control-input" id="@item.Id">
                                                                <label class="custom-control-label" for="@item.Id">@item.Name</label>
                                                            </div><!-- End .custom-checkbox -->
                                                        </div>
                                                    }
                                                }
											</div><!-- End .filter-items -->
										</div><!-- End .widget-body -->
									</div><!-- End .collapse -->
        						</div><!-- End .widget -->

        						<div class="widget widget-collapsible">
    								<h3 class="widget-title">
									    <a data-toggle="collapse" href="#widget-5" role="button" aria-expanded="true" aria-controls="widget-5">
									        Giá
									    </a>
									</h3><!-- End .widget-title -->

									<div class="collapse show" id="widget-5">
										<div class="widget-body">
                                            <div class="filter-price">
                                                <div class="filter-price-text">
                                                    Trong khoảng:
                                                    <span id="filter-price-range"></span>
                                                    <input type="hidden" value="" id="PriceFrom" />
                                                    <input type="hidden" value="" id="PriceTo" />
                                                </div><!-- End .filter-price-text -->

                                                <div id="price-slider"></div><!-- End #price-slider -->
                                            </div><!-- End .filter-price -->
										</div><!-- End .widget-body -->
									</div><!-- End .collapse -->
        						</div><!-- End .widget -->
                			</div><!-- End .sidebar sidebar-shop -->
                		</aside><!-- End .col-lg-3 -->
                	</div><!-- End .row -->
                </div><!-- End .container -->
            </div><!-- End .page-content -->
        </main>
@section css{
    <link rel="stylesheet" href="assets/css/plugins/nouislider/nouislider.css">
}
@section js{
    <script src="/assets/js/wNumb.js"></script>
    <script src="/assets/js/bootstrap-input-spinner.js"></script>
    <script src="/assets/js/nouislider.min.js"></script>
    <script>
        var currentPage = 1;

        $(function () {
            LoadProducts();

            // Slider For category pages / filter price
            if (typeof noUiSlider === 'object') {
                var priceSlider = document.getElementById('price-slider');

                // Check if #price-slider elem is exists if not return
                // to prevent error logs
                if (priceSlider == null) return;

                noUiSlider.create(priceSlider, {
                    start: [0, 3000],
                    connect: true,
                    step: 50,
                    margin: 200,
                    range: {
                        'min': 0,
                        'max': 5000
                    },
                    tooltips: true,
                    format: wNumb({
                        decimals: 0,
                        suffix: 'k VNĐ'
                    })
                });

                // Update Price Range
                priceSlider.noUiSlider.on('update', function (values, handle) {
                    $('#filter-price-range').text(values.join(' - '));
                    $("#PriceFrom").val(values[0].substring(0, values[0].length - 5));
                    $("#PriceTo").val(values[1].substring(0, values[1].length - 5));
                    LoadProducts();
                });
            }

            $(document).on("change", "input[name=category], input[name=size], input[name=brand]", function(event) {
                event.preventDefault();
                LoadProducts();
            })

            $(document).on("click", ".filter-colors a", function(event) {
                event.preventDefault();
                $(".filter-colors a").removeClass("selected");
                $(this).addClass("selected");
                LoadProducts();
            })

            $("#sortby").change(function(event) {
                event.preventDefault();
                LoadProducts();
            })

            $(document).on("click", ".pagination li a", function(event) {
                event.preventDefault();
                currentPage = $(this).data("page");
                $(".pagination li").removeClass("active");
                LoadProducts();
            })
        });  
        function LoadProducts() {
            let categories = $("input[name=category]:checked").map(function() {
                    return $(this).val();
                }).get();

            let sizes = $("input[name=size]:checked").map(function() {
                    return $(this).val();
                }).get();

            let brands = $("input[name=brand]:checked").map(function() {
                    return $(this).val();
                }).get();

            let color = $(".filter-colors a.selected").data("id");

            let priceFrom = parseInt($("#PriceFrom").val()) * 1000;

            let priceTo = parseInt($("#PriceTo").val()) * 1000;

            let sortBy = $("#sortby").val();

            jQuery.ajaxSettings.traditional = true;

            $.ajax({
            type: "GET",
            url: "@Url.Action("Products")",
            contentType: 'application/json; charset=UTF-8',
            data: {
                categories: categories,
                sizes: sizes,
                color: color,
                brands: brands,
                priceFrom: priceFrom,
                priceTo: priceTo,
                orderBy: sortBy,
                page: currentPage
            },
            dataType: "json",
            success: function(item) {
                $(".toolbox-info span").html(item["TotalItems"]);
                // Phân Trang
                let totalPages = parseInt(item["TotalPages"]);
                $(".pagination").html("");
                $(".pagination").append(`<li  class="page-item">
                                            <a data-page="${currentPage > 1 ? currentPage-1 : currentPage}" class="page-link page-link-prev" href="#" aria-label="Previous" tabindex="-1" aria-disabled="true">
                                                <span aria-hidden="true"><i class="icon-long-arrow-left"></i></span>Trước
                                            </a>
							            </li>`);
                let start = 1, end = totalPages;
                if (currentPage - 2 > 1)
                    start = currentPage - 2;
                if (currentPage + 2 < totalPages)
                    end = currentPage + 2;
                for (let i = start; i <= end; i++)
                {
                    $(".pagination").append(`<li class="page-item"><a data-page="${i}" class="page-link" href="#">${i}</a></li>`);
                }
                $(".pagination").append(`<li class="page-item">
                                            <a data-page="${currentPage < totalPages ? currentPage+1 : currentPage}" class="page-link page-link-next" href="#" aria-label="Next">
                                                Sau <span aria-hidden="true"><i class="icon-long-arrow-right"></i></span>
                                            </a>
                                        </li>`);
                $(".pagination li a[data-page = "+currentPage+"]").parent().addClass("active");
                $(".pagination .page-link-prev, .pagination .page-link-next").parent().removeClass("active");
                if (currentPage == 1)
                    $(".pagination .page-link-prev").parent().addClass("disabled");
                if (currentPage == totalPages)
                    $(".pagination .page-link-next").parent().addClass("disabled");
                $("#products").html("");
                item["Products"].forEach(function(element) {
                    let picture = "";
                    let pic = element[5].split(", ");
                    for (let i = 0; i < pic.length; i++) {
                        picture += ` <a href="#" class="active">
                                        <img src="/assets/images/products/${pic[i].trim()}" alt="product desc">
                                    </a>`
                    }
                    let product = `<div class="product product-list">
                                    <div class="row">
                                        <div class="col-6 col-lg-3">
                                            <figure class="product-media">
                                                <a href="/Home/Details/${element[0]}">
                                                    <img src="/assets/images/products/${element[1].split(',')[0].trim()}" alt="Product image" class="product-image">
                                                </a>
                                            </figure><!-- End .product-media -->
                                        </div><!-- End .col-sm-6 col-lg-3 -->

                                        <div class="col-6 col-lg-3 order-lg-last">
                                            <div class="product-list-action">
                                                <div class="product-price">
                                                    ${element[6].replace(/\B(?=(\d{3})+(?!\d))/g, ',')} VNĐ
                                                </div><!-- End .product-price -->
                                                <div class="ratings-container">
                                                    <div class="ratings">
                                                        <div class="ratings-val" style="width: ${Math.floor(element[8]*20)}%;"></div><!-- End .ratings-val -->
                                                    </div><!-- End .ratings -->
                                                    <span class="ratings-text">( ${element[7]} bình chọn )</span>
                                                </div><!-- End .rating-container -->
                                                <a href="/Home/Details/${element[0]}" class="btn btn-primary"><span>Xem chi tiết</span></a>
                                            </div><!-- End .product-list-action -->
                                        </div><!-- End .col-sm-6 col-lg-3 -->

                                        <div class="col-lg-6">
                                            <div class="product-body product-action-inner">
                                                <div class="product-cat">
                                                    <a href="#">${element[2]}</a>
                                                </div><!-- End .product-cat -->
                                                <h3 class="product-title"><a href="/Home/Details/${element[0]}">${element[3]}</a></h3><!-- End .product-title -->

                                                <div class="product-content">
                                                    <p>${element[4]}</p>
                                                </div><!-- End .product-content -->
                                                
                                                <div class="product-nav product-nav-thumbs">
                                                    ${picture}
                                                </div><!-- End .product-nav -->
                                            </div><!-- End .product-body -->
                                        </div><!-- End .col-lg-6 -->
                                    </div><!-- End .row -->
                                </div>`
                                $("#products").append(product)
                })
            },
            error: function(req, status, error) {
                console.log(status);
            }
        });
        }
    </script>
}